name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint (All Modules)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install Linting Tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy

      - name: Lint Root Module
        run: |
          echo "::group::Root Module"
          ruff check .
          ruff format --check .
          mypy main.py snow_flask_core/ --ignore-missing-imports
          echo "::endgroup::"

      - name: Lint AWS Module
        run: |
          echo "::group::AWS Module"
          cd snow-flask-whoami-aws
          ruff check handler.py
          ruff format --check handler.py
          python -m py_compile handler.py
          echo "::endgroup::"

      - name: Lint Azure Module
        run: |
          echo "::group::Azure Module"
          cd snow-flask-whoami-az
          ruff check snow-flask-whoami-az/__init__.py
          ruff format --check snow-flask-whoami-az/__init__.py
          python -m py_compile snow-flask-whoami-az/__init__.py
          echo "::endgroup::"

      - name: Lint GCP Module
        run: |
          echo "::group::GCP Module"
          cd snow-flask-whoami-gpc
          ruff check main.py
          ruff format --check main.py
          python -m py_compile main.py
          echo "::endgroup::"

  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          pip install -r requirements.txt

      - name: Run Root Tests
        run: pytest tests/ -v --cov=snow_flask_core --cov-report=term-missing

  status-check:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: always()
    steps:
      - name: Verify all jobs passed
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ]; then
            echo "One or more checks failed"
            exit 1
          fi
          echo "All checks passed"
